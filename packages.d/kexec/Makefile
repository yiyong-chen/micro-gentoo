include $(TOP)/config.mk
include config.mk

KEXEC_BINARY = kexec-$(KEXEC_STRONG_VERSION)/sbin/kexec
KEXEC_BUILD_PRODUCT = $(KEXEC_SOURCETREE)/build/sbin/kexec
KEXEC_STRIPPED = $(KEXEC_BUILD_PRODUCT)-stripped
KEXEC_MAKEFILE = $(KEXEC_SOURCETREE)/Makefile
KEXEC_CONFIGURE = $(KEXEC_SOURCETREE)/configure

all: $(KEXEC_BINARY)

clean:
	rm -rf kexec-*

$(KEXEC_BINARY): $(KEXEC_STRIPPED)
	mkdir -p kexec-$(KEXEC_STRONG_VERSION)/sbin
	cp $(KEXEC_STRIPPED) $(KEXEC_BINARY)

$(KEXEC_STRIPPED): $(KEXEC_BUILD_PRODUCT)
	cp $(KEXEC_BUILD_PRODUCT) $(KEXEC_STRIPPED)
	strip $(KEXEC_STRIPPED)

$(KEXEC_BUILD_PRODUCT): $(KEXEC_MAKEFILE)
	$(MAKE) -j4 -C $(KEXEC_SOURCETREE)

$(KEXEC_MAKEFILE): $(KEXEC_CONFIGURE)
	cd $(KEXEC_SOURCETREE) && ./configure 

$(KEXEC_CONFIGURE): | $(KEXEC_TARBALL)
	tar -xvJf $(KEXEC_TARBALL)

$(KEXEC_TARBALL):
	curl $(KEXEC_SOURCE) > $(KEXEC_TARBALL) 2>/dev/null || rm -f $(KEXEC_TARBALL)
